---
title: "Modelo predictivo de precios de coches"
author: "Grupo 8 - FID"
output: html_document
---

## Introducción
(Escribir introducción)

## Importación de librerias
```{r}
# Importación de librerías
library(caret)
library(tidyverse)
library(dplyr)
```

## Carga de datos
```{r}
# Carga de ficheros:
car_data_1 <- read.csv("datasets/car_data_1.csv")
car_data_2 <- read.csv("datasets/car_data_2.csv")
car_data_3 <- read.csv("datasets/car_data_3.csv")
car_data_4 <- read.csv("datasets/car_data_4.csv")
```

## Visualización inicial de los datos
Tenemos un total de 4 datasets distintos, por lo que procederemos a analizar cada uno de ellos, teniendo en cuenta los datos y atributos que tiene. Para ello, crearemos un par de funciones que nos serán de ayuda.

```{r}
# Función para conocer el número de valores distintos de cada atributo de un dataset
numero_valores_distintos <- function(car_dataset) {
  nombres_atributos <- names(car_dataset)
  num_valores_distintos_por_atributo <- numeric(length = length(nombres_atributos))
  for (i in seq_along(nombres_atributos)) {
    atributo_actual <- nombres_atributos[i]
    valores_distintos <- unique(car_dataset[, atributo_actual])
    num_valores_distintos_por_atributo[i] <- length(valores_distintos)
  }
  resultados <- data.frame(Atributo = nombres_atributos, NumValoresDistintos = num_valores_distintos_por_atributo)
  print(resultados)
}

# Función para conocer los posibles valores de unos atributos proporcionados de un dataset
valores_distintos <- function(car_dataset, nombres_atributos) {
  valores_distintos_por_atributo <- list()
  for (i in seq_along(nombres_atributos)) {
    atributo_actual <- nombres_atributos[i]
    valores_distintos <- unique(car_dataset[, atributo_actual])
    valores_distintos_por_atributo[[i]] <- valores_distintos
  }
  resultados <- data.frame(
    Atributo = nombres_atributos,
    ValoresDistintos = sapply(valores_distintos_por_atributo, function(x) toString(x)),
    stringsAsFactors = FALSE
  )
  print(resultados)
}
```

Empezaremos con el dataset "car_data_1".

```{r}
# Resumen del dataset
summary(car_data_1)
```
Como podemos observar, hay un total de 301 entradas en este dataset. Hay 9 atributos distintos. Veamos el número de valores distintos que tiene cada atributo.

```{r}
numero_valores_distintos(car_data_1)
```
En el caso del atributo "name", que indica el modelo del vehículo, podemos observar que existen 98 coches distintos. El año de fabricación tiene un total de 16 valores distintos (desde 2003 hasta 2018, como hemos visto en la función summary). El precio de venta y el precio actual tienen 156 y 147 valores distintos, respectivamente. Existen 206 valores de kilometraje diferentes.

Es interesante saber que existen 3 tipos de combustibles, 2 tipos de vendedores, 2 tipos de transmisiones y 3 tipos de propietarios. A continuación, mostramos cada uno para observar los posibles valores.

```{r}
# Obtenemos los últimos atributos del dataset
nombres_atributos <- names(car_data_1)[(ncol(car_data_1) - 3):ncol(car_data_1)]

# Llamamos a la función
valores_distintos(car_data_1, nombres_atributos)
```

Como podemos observar, el tipo de combustible, el tipo de vendedor y el tipo de transmisión tienen valores de texto, mientras que el tipo de propietario tiene los valores numéricos 0, 1 y 3.

Analicemos a continuación el dataset "car_data_2". Procederemos de manera similar a como se ha hecho con el primer dataset.

```{r}
# Resumen del dataset
summary(car_data_2)
```
Existen un total de 4340 entradas en el dataset. Hay 8 atributos distintos que, como podemos observar, son similares a los del primer dataset, a excepción del precio actual que no se encuentra en el dataset "car_data_2". Veamos el número de valores distintos que tiene cada atributo.

```{r}
numero_valores_distintos(car_data_2)
```

A diferencia del dataset anterior, el atributo de modelo del coche tiene un número de valores distintos más elevado al de los atributos año de fabricación, precio de venta y kilometraje.

Volvemos a encontrarnos con un pequeño número de valores posibles en el tipo de combustible, tipo de vendedor, tipo de transmisión y tipo de propietario. Veamos estos valores.

```{r}
# Obtenemos los últimos atributos del dataset
nombres_atributos <- names(car_data_2)[(ncol(car_data_2) - 3):ncol(car_data_2)]

# Llamamos a la función
valores_distintos(car_data_2, nombres_atributos)
```

Podemos observar varias diferencias entre los valores de este dataset y del anterior. El tipo de combustible tiene dos nuevos valores posibles con respecto al dataset "car_data_1". Así mismo, el tipo de vendedor incluye también el valor "Trustmark Dealer". Los tipos de transmisiones son iguales en ambos dataset. La mayor diferencia se encuentra en el tipo de propietarios, ya que en este dataset aparecen 5 posibles valores en formato texto, mientras que en el anterior solo aparecían 3 valores en formato numérico.

Proseguimos con el dataset "car_data_3".

```{r}
# Resumen del dataset
summary(car_data_3)
```

Existen un total de 8128 entradas en este dataset. Hay un total de 13 atributos distintos que suponen diferencias con el resto de los datasets usados. Veamos el número de valores distintos que tiene cada atributo.

```{r}
numero_valores_distintos(car_data_3)
```

Existen un total de 2058 modelos de coche distintos en este dataset. Como anteriormente, procedemos a analizar los posibles valores de los atributos tipo de combustible, tipo de vendedor, tipo de transmisión y tipo de propietario, que pueden ser interesantes para nuestro estudio.


```{r}
# Obtenemos los atributos del dataset que nos interesan
nombres_atributos <- names(car_data_3)[(ncol(car_data_3) - 8):(ncol(car_data_3) - 5)]

# Llamamos a la función
valores_distintos(car_data_3, nombres_atributos)
```

Observamos que los valores de los atributos son iguales a los del dataset "car_data_2", a excepción del tipo de combustible, que en el dataset anterior también contiene el valor "Electric".

Seguimos el análisis con el último dataset, "car_data_4".

```{r}
# Resumen del dataset
summary(car_data_4)
```

Existen un total de 2059 entradas en este dataset. Además, este dataset es el que mayor número de atributos tiene, con un total de 20. Los atributos que hemos visto en común en los datasets anteriores también aparecen en este, aunque en el caso del modelo del coche se muestra en dos atributos diferenciados, "Make" (marca) y "Model" (modelo). Veamos el número de valores distintos que tiene cada atributo.

```{r}
numero_valores_distintos(car_data_4)
```

Como podemos observar, existen 33 marcas de coches distintas en el dataset, y un total de 1050 modelos. Procedemos a analizar los posibles valores de los atributos tipo de combustible, tipo de vendedor, tipo de transmisión y tipo de propietario, como hemos hecho con los anteriores datasets.

```{r}
# Obtenemos los atributos del dataset que nos interesan
nombres_atributos <- c("Fuel.Type", "Transmission", "Owner", "Seller.Type")

# Llamamos a la función
valores_distintos(car_data_4, nombres_atributos)
```

Los valores de estos atributos en el dataset "car_data_4" tienen bastantes diferencias con el resto de datasets. Este posee un mayor número de valores en el tipo de combustible. Además, los tipos de propietario son diferentes a los que hemos observado en los datasets anteriores, aunque reflejan lo mismo en varios casos (por ejemplo, "First" refleja el mismo valor que "First Owner"). El tipo de vendedor solo comparte el valor "Individual", aunque "Corporate" podría reflejar lo mismo que "Dealer" y "Commercial Registration" podría reflejar el mismo valor que "Trustmark Dealer".

## Preprocesado de datos
Dado el objetivo del presente trabajo, se ha tomado la decisión de desestimar el primer dataset "car_data_1", dado que se ha detectado una gran diferencia con el resto de datos de los datasets restantes, lo que dificultaría las tareas de preprocesado, algo que no se pretende en el trabajo desarrollado.

Uno de los datos más relevantes a la hora de realizar un predicción del precio es conocer la marca y el modelo del vehículo. Como hemos podido observar, los datasets "car_data_2" y "car_data_3" tienen una estructura similar en la que la marca y el modelo del coche aparecen en el mismo atributo "name". Sin embargo, en el dataset "car_data_4", aparecen dos aributos "Make" y "Model" (marca y modelo, respectivamente). Dado que ambos son valores a tener en cuenta de forma individual, se ha optado por separar el atributo "name" de los datasets "car_data_2" y "car_data_3" en dos atributos diferentes.

```{r}
# Usando la función mutate, creamos dos nuevos atributos a partir del atributo name
car_data_2 <- car_data_2 %>%
  mutate(
    make = sapply(strsplit(as.character(name), " "), function(x) x[1]),
    model = sapply(strsplit(as.character(name), " "), function(x) paste(x[-1], collapse = " "))
  )

# Eliminamos el atributo name, ya que no lo usaremos
car_data_2 <- car_data_2 %>% select(-name)

# Reorganizamos los atributos, poniendo primero los atributos make y model
car_data_2 <- car_data_2 %>% select(make, model, everything())

# Comprobamos que los atributos se han creado, borrado y reorganizado de manera correcta
head(car_data_2)
```

A continuación, realizamos las mismas operaciones con el dataset "car_data_3".

```{r}
# Usando la función mutate, creamos dos nuevos atributos a partir del atributo name
car_data_3 <- car_data_3 %>%
  mutate(
    make = sapply(strsplit(as.character(name), " "), function(x) x[1]),
    model = sapply(strsplit(as.character(name), " "), function(x) paste(x[-1], collapse = " "))
  )

# Eliminamos el atributo name, ya que no lo usaremos
car_data_3 <- car_data_3 %>% select(-name)

# Reorganizamos los atributos, poniendo primero los atributos make y model
car_data_3 <- car_data_3 %>% select(make, model, everything())

# Comprobamos que los atributos se han creado, borrado y reorganizado de manera correcta
head(car_data_3)
```

A continuación, proprocesaremos el dataset "car_data_4". En primer lugar, hemos observado que la marca de coches Maruti se define en este dataset como Maruti Suzuki. Con el fin de poder unificar los datos de todos los datasets, procedemos a eliminar la palabra "Suzuki" para que la marca del coche figure solo como "Maruti", al igual que ocurre en los datasets "car_data_2" y "car_data_3".

```{r}
# Usando la función mutate, nos quedamos con la primera palabra de cada fila
car_data_4 <- car_data_4 %>%
  mutate(
    Make = word(Make, 1)
  )

# Comprobamos que el atributo se ha cambiado de manera correcta
head(car_data_4)
```

Ahora buscamos quedarnos con los atributos que nos puedan ser de ayuda en el presente trabajo. Estos atributos son la marca, el modelo, el año de fabricación, el precio de venta, el kilometraje, el tipo de combustible, el tipo de vendedor, el tipo de transmisión y el propietario del coche. Para ello, debemos ajustar el nombre de estos atributos en todos los datasets, de manera que queden como "make", "model", "year", "selling_price", "km_driven", "fuel", "seller_type", "transmission" y "owner". Podemos observar que el "car_data_2" y el "car_data_3" ya poseen estos atributos, por lo que procesaremos el "car_data_4".

```{r}
# Vamos a renombrar cada atributo con el nombre que hemos definido
car_data_4 <- car_data_4 %>%
  rename_with(~ "make", .cols = "Make") %>%
  rename_with(~ "model", .cols = "Model") %>%
  rename_with(~ "selling_price", .cols = "Price") %>%
  rename_with(~ "year", .cols = "Year") %>%
  rename_with(~ "km_driven", .cols = "Kilometer") %>%
  rename_with(~ "fuel", .cols = "Fuel.Type") %>%
  rename_with(~ "transmission", .cols = "Transmission") %>%
  rename_with(~ "owner", .cols = "Owner") %>%
  rename_with(~ "seller_type", .cols = "Seller.Type")

# Comprobamos que los atributos se han cambiado de manera correcta
head(car_data_4)
```

Procederemos a seleccionar los atributos que usaremos de cada uno de los datasets que usaremos en el proyecto. El dataset "car_data_2" ya posee solo los atributos normalizados, así que procesaremos los datasets "car_data_3" y "car_data_4".

```{r}
# Seleccionamos los atributos del car_data_3
car_data_3 <- car_data_3 %>% select(make, model, year, selling_price, km_driven, fuel, seller_type, transmission, owner)

# Comprobamos que los atributos se han seleccionado de manera correcta
head(car_data_3)

# Seleccionamos los atributos del car_data_4
car_data_4 <- car_data_4 %>% select(make, model, year, selling_price, km_driven, fuel, seller_type, transmission, owner)

# Comprobamos que los atributos se han seleccionado de manera correcta
head(car_data_4)
```

Normalización de los valores del dataset "car_data_4" en los atributos seller_type y owner

```{r}
# Diccionario con los valores antiguos y los nuevos de seller_type
dicc_valores_seller <- c("Corporate" = "Dealer", "Commercial Registration" = "Trustmark Dealer")

car_data_4 <- car_data_4 %>%
  mutate(seller_type = ifelse(seller_type %in% names(dicc_valores_seller), dicc_valores_seller[seller_type], seller_type))

# Diccionario con los valores antiguos y los nuevos de seller_type
dicc_valores_owner <- c("First" = "First Owner", "Second" = "Second Owner", "Third" = "Third Owner", "Fourth" = "Fourth & Above Owner", "4 or More" = "Fourth & Above Owner", "UnRegistered Car" = "Test Drive Car")

car_data_4 <- car_data_4 %>%
  mutate(owner = ifelse(owner %in% names(dicc_valores_owner), dicc_valores_owner[owner], owner))

# Comprobamos que los atributos se han seleccionado de manera correcta
head(car_data_4)
```



A continuación nos centraremos en realizar una análisis de regresión con el dataset número 1.

```{r}
# Analisis descriptivo Kilometraje - precio
set.seed(123)
train_index <- createDataPartition(car_data_1$Selling_Price, p = 0.8, list = FALSE)
train_data <- car_data_1[train_index, ]
train_data <- na.omit(train_data)
test_data <- car_data_1[-train_index, ]

# Exploración de Datos (EDA)
summary(train_data)
ggplot(train_data, aes(x = Kms_Driven, y = Selling_Price)) +
  geom_point() +
  ggtitle("Relación entre Kilometraje y Precio")

# Modelado (Regresión Lineal)
model <- lm(Selling_Price ~ Kms_Driven + Year + Fuel_Type + Transmission + Owner + Seller_Type, data = train_data)
summary(model)

# Evaluación del Modelo en Datos de Prueba
# Realizar predicciones en el conjunto de prueba
predictions <- predict(model, newdata = test_data)

# Comparar las predicciones con los valores reales
comparison <- data.frame(Real = test_data$Selling_Price, Predicciones = predictions)

# Visualizar las primeras filas de la comparación
head(comparison)

# Crear un gráfico de dispersión para visualizar las predicciones
ggplot(comparison, aes(x = Real, y = Predicciones)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  ggtitle("Comparación entre Valores Reales y Predicciones") +
  xlab("Precio Real") +
  ylab("Predicciones")

# Calcular el Error Cuadrático Medio (MSE) en el conjunto de prueba
mse <- mean((predictions - test_data$Selling_Price)^2)
r_squared <- cor(predictions, test_data$Selling_Price)^2

cat("Error Cuadrático Medio (MSE):", mse, "\n")
cat("Coeficiente de Determinación (R²):", r_squared, "\n")

```
Del car_data_1, hemos creado un modelo de entrenamiento predictivo.
Obtenemos un MSE de 4.783 y un Coeficiente de Determinación 0.72.
Esto significa que, en promedio, las predicciones del modelo tienen un error cuadrático medio de aproximadamente 4.78 unidades de precio al cuadrado; y que aproximadamente el 71.76% de la variabilidad en el precio de venta se explica por las variables incluidas en el modelo.
En estas gráficas podemos ver la relacion kilómetros recorridos por precio en venta, y la predicción de nuestro modelo relacionando las mismas variables. Vemos que este modelo todavía se puede mejorar y ajustar más.

# **Vehicle Dataset** 
#  es ideal para modelos predictivos, especialmente regresión, y puede ser interesante si estás enfocado en análisis de mercado y precios.
# - **Modelos de Regresión Lineal y No Lineal para Predicción de Precios**: Pueden ser más o menos complejos dependiendo de la cantidad y tipo de variables involucradas. En general, este tipo de modelo es manejable para alguien con una comprensión básica de la ciencia de datos.
# - **Análisis Descriptivo**: Al igual que con el conjunto de datos de salarios, realizar análisis descriptivos es relativamente fácil y puede ofrecer insights valiosos.
